<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>  
<title>Random History</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="css/history.css">
<style>
    .highlight {
        background-color: #007bff !important;
        color: white !important;
    }
    .pagination-container {
        margin-top: 10px;
        text-align: center;
    }
    .pagination-button {
        margin: 0 5px;
        padding: 5px 10px;
        cursor: pointer;
    }
    .pagination-button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    .hidden-id {
        display: none;
    }
    /* Add alternating row colors */
    #history-table tbody tr:nth-child(odd) {
        background-color: #f9f9f9;
    }
    #history-table tbody tr:nth-child(even) {
        background-color: #e9e9e9;
    }
	.modal {
	        display: none;
	        position: fixed;
	        z-index: 1;
	        left: 0;
	        top: 0;
	        width: 100%;
	        height: 100%;
	        overflow: auto;
	        background-color: rgb(0, 0, 0);
	        background-color: rgba(0, 0, 0, 0.4);
	        padding-top: 60px;
	    }
	
	    .modal-content {
	        background-color: #fefefe;
	        margin: 5% auto;
	        padding: 20px;
	        border: 1px solid #888;
	        width: 25%;
	    }
	
	    .close {
	        color: #aaa;
	        float: right;
	        font-size: 28px;
	        font-weight: bold;
	    }
	
	    .close:hover,
	    .close:focus {
	        color: black;
	        text-decoration: none;
	        cursor: pointer;
	    }
</style>
</head>

<body>
    <div class="search-container">  
        <input id="charInput" type="text" class="search-input" placeholder="组名">  
        <input type="text" class="search-input date-picker" id="start-date" placeholder="起始时间">
        <input type="text" class="search-input date-picker" id="end-date" placeholder="结束时间">
		<div id="button-container">
			<button class="search-button" id="search-button">搜索</button>
			<button class="report-button" id="report-button">导出</button>
			<button class="delete-button" id="delete-button">删除</button>
			<button class="clear-button" id="clear-button">清除全部</button>
		</div>
    </div> 
    <table id="history-table">
        <thead>
        <tr>
            <th scope="col">序号</th>
            <th scope="col">随机组</th>
            <th scope="col">执行结果</th>
            <th scope="col">执行时间</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <div class="pagination-container">
        <button class="pagination-button" id="prev-page">上一页</button>
        <span id="page-info"></span>
        <button class="pagination-button" id="next-page">下一页</button>
    </div>
	<div id="myModal" class="modal">
	        <!-- Modal content -->
	        <div class="modal-content">
	            <span class="close">&times;</span>
	            <h2 class="modal-title">随机详情</h2>
	            <table class="modal-table">
	                <thead>
	                    <tr>
	                        <th class="modal-table-item">随机项</th>
	                        <th class="modal-table-item">概率</th>
	                    </tr>
	                </thead>
	                <tbody id="modalTableBody">
	                    <!-- Rows will be added dynamically -->
	                </tbody>
	            </table>
	        </div>
	    </div>
</body>
<script>
    // script.js
    var currentPage = 1;
    var pageSize = 10;
    var totalRecords = 0;
    var allData = []; // 用于存储所有查询数据
    var lastSelectedRowIndex = null;
    
    $(document).ready(function() {  
        $('.search-button').click(function() {  
            var charValue = $('#charInput').val();  
            var startDateValue = $('#start-date').val();  
            var endDateValue = $('#end-date').val(); 
			
            currentPage = 1;
            fetchData(charValue, startDateValue, endDateValue);
        });
		
		$('#report-button').click(function(){
			 $(this).prop('disabled', true);
			reportDate().done(function(){
				$('#report-button').prop('disabled', false);
			}).fail(function(){
				$('#report-button').prop('disabled', false);
			});
		});
    
        $('#delete-button').click(function() {
            var selectedIds = getSelectedIds();
            if (selectedIds.length > 0) {
                deleteSelectedRecords(selectedIds);
            } else {
                alert("请通过单击选择要删除的记录");
            }
        });
        
        $('#clear-button').click(function() {
            const userConfirmed = confirm('确定清除所有历史记录吗？');
            if(userConfirmed){
                deleteAllMyRecords();
            }
        });
    
        $('#prev-page').click(function() {
            if (currentPage > 1) {
                currentPage--;
                populateTable(currentPage, pageSize);
            }
        });
    
        $('#next-page').click(function() {
            var totalPages = Math.ceil(totalRecords / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                populateTable(currentPage, pageSize);
            }
        });
    
        $(document).keydown(function(event) {  
            if (event.key === 'Enter') {  
                event.preventDefault();  
                $('#search-button').click();  
            }  
        });
    });
    
    $(document).ready(function() {
        flatpickr('#start-date', {  
            enableTime: true,  
            dateFormat: 'Y-m-d H:i:S',  
            altInput: true,  
            altFormat: 'Y-m-d H:i:S',  
            locale: 'zh'
        });  
        
        flatpickr('#end-date', {  
            enableTime: true,  
            dateFormat: 'Y-m-d H:i:S',  
            altInput: true,  
            altFormat: 'Y-m-d H:i:S',  
            locale: 'zh'
        });
    });
    
    function fetchData(charValue, startDate, endDate) {  
        $.ajax({  
            url: 'http://localhost:8001/random/randomHistory/historyPage',   
            type: 'POST',  
            dataType: 'json',
            data: {
                randomCategory: charValue,
                startTime: startDate,
                endTime: endDate,
                pageNum: 1,
                pageSize: 10000 // 一次请求所有数据
            },
            success: function(data) { 
				if(data.code === 200){
					totalRecords = data.total;
					allData = data.rows;
					populateTable(currentPage, pageSize);
				}else{
					alert(data.msg);
				}
            } 
        });  
    }  
	
	function reportDate() {
	    $.ajax({
	        url: 'http://localhost:8001/random/randomHistory/report',
	        type: 'GET',
	        xhrFields: { responseType: 'blob' },
	        success: function(data) {
	            var blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
	            var link = document.createElement('a');
	            link.href = window.URL.createObjectURL(blob);
	            link.download = 'history.xlsx';
	            document.body.appendChild(link);
	            link.click();
	            document.body.removeChild(link);
	            alert("导出成功！");
	        },
	        error: function() {
	            alert("导出失败！");
	        }
	    });
	}

    
    function populateTable(pageNum, pageSize) {
        var tbody = $('#history-table tbody');  
        tbody.empty();
        var start = (pageNum - 1) * pageSize;
        var end = start + pageSize;
        var pageData = allData.slice(start, end);
        
        $.each(pageData, function(index, item) {  
            var tr = $('<tr>').append(  
                $('<td>').text(start + index + 1),  
                $('<td>').text(item.randomCategory),  
                $('<td>').text(item.runResult),  
                $('<td>').text(item.runTime),
                $('<td>').addClass('hidden-id').text(item.id)
            );  
            tbody.append(tr);  
        });
        
        updatePaginationInfo(pageNum, pageSize, totalRecords);
        attachRowClickEvent();
        attachRowDblClickEvent();
    }
    
    function updatePaginationInfo(pageNum, pageSize, totalRecords) {
        var totalPages = Math.ceil(totalRecords / pageSize);
        $('#page-info').text('第' + pageNum + '/' + totalPages + '页');
    }
    
    function attachRowClickEvent() {
        $('#history-table tbody tr').off('click').on('click', function(event) {
            if (event.ctrlKey) {
                $(this).toggleClass('highlight');
            } else if (event.shiftKey) {
                if (lastSelectedRowIndex !== null) {
                    var currentIndex = $(this).index();
                    var start = Math.min(lastSelectedRowIndex, currentIndex);
                    var end = Math.max(lastSelectedRowIndex, currentIndex);
                    for (var i = start; i <= end; i++) {
                        $('#history-table tbody tr').eq(i).addClass('highlight');
                    }
                }
            } else {
                $(this).toggleClass('highlight').siblings().removeClass('highlight');
            }
            lastSelectedRowIndex = $(this).index();
        });
    }
    
    function attachRowDblClickEvent() {
        $('#history-table tbody tr').off('dblclick').on('dblclick', function() {
            var historyId = $(this).find('.hidden-id').text();
            fetchDetailsAndShowModal(historyId);
        });
    }
    
    function getSelectedIds() {
        var selectedIds = [];
        $('#history-table tbody tr.highlight').each(function() {
            var id = $(this).find('.hidden-id').text();
            selectedIds.push(id);
        });
        return selectedIds;
    }
    
    function deleteSelectedRecords(ids) {
        $.ajax({
            url: 'http://localhost:8001/random/randomHistory/historyClean',
            type: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify(ids),
            success: function(response) {
                var charValue = $('#charInput').val();  
                var startDateValue = $('#start-date').val();  
                var endDateValue = $('#end-date').val();
                fetchData(charValue, startDateValue, endDateValue);
            }
        });
    }
    
    function deleteAllMyRecords() {
        $.ajax({
            url: 'http://localhost:8001/random/randomHistory/historyCleanAll',
            type: 'DELETE',
            contentType: 'application/json',
            success: function(response) {
                var charValue = $('#charInput').val();  
                var startDateValue = $('#start-date').val();  
                var endDateValue = $('#end-date').val();
                fetchData(charValue, startDateValue, endDateValue);
            }
        });
    }
    
    function fetchDetailsAndShowModal(historyId) {
        $.ajax({
            url: 'http://localhost:8001/random/randomHistory/historyOption/' + historyId,
            type: 'GET',
			dataType: 'json',
            // data: { id: historyId },
            success: function(data) {
                var modalTableBody = $('#modalTableBody');
                modalTableBody.empty();
                $.each(data.data, function(index, detail) {
					var probabilityText = detail.probability === null ? "默认" : detail.probability + "%";
                    var tr = $('<tr>').append(
                        $('<td>').text(detail.optionName),
                        $('<td>').text(probabilityText)
                    );
                    modalTableBody.append(tr);
                });
                $('#myModal').show();
            }
        });
    }
    
    $(document).ready(function() {
        var modal = $('#myModal');
        var span = $('.close');
    
        span.click(function() {
            modal.hide();
        });
    
        $(window).click(function(event) {
            if ($(event.target).is(modal)) {
                modal.hide();
            }
        });
    });
    
    fetchData('', '', '');

</script>
</html>
